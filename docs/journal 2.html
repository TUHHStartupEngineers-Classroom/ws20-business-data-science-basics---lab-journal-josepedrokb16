<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jose Pedro Kitajima Borges" />

<meta name="date" content="2020-11-05" />

<title>Journal (reproducible report)</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MyLabJournal</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="journal.html">Journal</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Class notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="dictionary.html">Dictionary</a>
    </li>
    <li>
      <a href="data_wrangling.html">Data Wrangling</a>
    </li>
    <li>
      <a href="ggplot_graphs.html">ggplot graphs</a>
    </li>
    <li>
      <a href="machine_learning.html">machine learning</a>
    </li>
  </ul>
</li>
<li>
  <a href="links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Journal (reproducible report)</h1>
<h4 class="author">Jose Pedro Kitajima Borges</h4>
<h4 class="date">2020-11-05</h4>

</div>


<p><strong>IMPORTANT:</strong> You can delete everything in here and start fresh. You might want to start by not deleting anything above this line until you know what that stuff is doing.</p>
<p>This is an <code>.Rmd</code> file. It is plain text with special features. Any time you write just like this, it will be compiled to normal text in the website. If you put a # in front of your text, it will create a top level-header.</p>
<div id="my-first-post" class="section level1">
<h1><span class="header-section-number">1</span> My first post</h1>
<p>Last compiled: 2020-12-05</p>
<p>Notice that whatever you define as a top level header, automatically gets put into the table of contents bar on the left.</p>
<div id="second-level-header" class="section level2">
<h2><span class="header-section-number">1.1</span> Second level header</h2>
<p>You can add more headers by adding more hashtags. These won’t be put into the table of contents</p>
<div id="third-level-header" class="section level3">
<h3><span class="header-section-number">1.1.1</span> third level header</h3>
<p>Here’s an even lower level header</p>
</div>
</div>
</div>
<div id="my-second-post-note-the-order" class="section level1">
<h1><span class="header-section-number">2</span> My second post (note the order)</h1>
<p>Last compiled: 2020-12-05</p>
<p>I’m writing this tutorial going from the top down. And, this is how it will be printed. So, notice the second post is second in the list. If you want your most recent post to be at the top, then make a new post starting at the top. If you want the oldest first, do, then keep adding to the bottom</p>
</div>
<div id="adding-r-stuff" class="section level1">
<h1><span class="header-section-number">3</span> Adding R stuff</h1>
<p>So far this is just a blog where you can write in plain text and serve your writing to a webpage. One of the main purposes of this lab journal is to record your progress learning R. The reason I am asking you to use this process is because you can both make a website, and a lab journal, and learn R all in R-studio. This makes everything really convenient and in the same place.</p>
<p>So, let’s say you are learning how to make a histogram in R. For example, maybe you want to sample 100 numbers from a normal distribution with mean = 0, and standard deviation = 1, and then you want to plot a histogram. You can do this right here by using an r code block, like this:</p>
<pre class="r"><code>samples &lt;- rnorm(100, mean=0, sd=1)
hist(samples)</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>When you knit this R Markdown document, you will see that the histogram is printed to the page, along with the R code. This document can be set up to hide the R code in the webpage, just delete the comment (hashtag) from the cold folding option in the yaml header up top. For purposes of letting yourself see the code, and me see the code, best to keep it the way that it is. You’ll learn that all of these things and more can be customized in each R code block.</p>
<pre class="r"><code>numbers &lt;- 1:1000

# This will print the first 10 elements of the vector numbers
numbers[1:10]</code></pre>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<pre class="r"><code># This will plot a histogram of 100 random elements of the vector numbers
hist(sample(numbers, 100, replace = T))</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="challenge-2---intro-to-the-tidyverse" class="section level1">
<h1><span class="header-section-number">4</span> Challenge 2 - Intro to the tidyverse</h1>
<div id="business-case-and-challenge" class="section level2">
<h2><span class="header-section-number">4.1</span> Business Case and Challenge</h2>
<p>The goal is to analyze the sales of bikes through stores in Germany. Data is organized as “sales by location” and “sales by year and location”.</p>
<p>Bike sales data divided into multiple data sets. Entity-relationship diagrams describe and define the data models. They explain the logical structure of the database.</p>
</div>
<div id="importing-data" class="section level2">
<h2><span class="header-section-number">4.2</span> Importing data</h2>
<p>The first step is to import the necessary libraries</p>
<pre class="r"><code>library(tidyverse)
library(readxl)
library(lubridate)</code></pre>
<p>We then read all of the Excel files</p>
<pre class="r"><code>bikes_tbl &lt;- read_excel(path = &quot;DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx&quot;)
orderlines_tbl &lt;- read_excel(path = &quot;DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx&quot;)
bikeshops &lt;- read_excel(path = &quot;DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx&quot;)</code></pre>
</div>
<div id="data-organization" class="section level2">
<h2><span class="header-section-number">4.3</span> Data Organization</h2>
<p>The next step is to combine all of the tables into one concise table</p>
<pre class="r"><code>bike_orderlines_joined_tbl &lt;- left_join(orderlines_tbl, bikes_tbl, by = c(&quot;product.id&quot;=&quot;bike.id&quot;)) %&gt;% left_join(bikeshops, by = c(&quot;customer.id&quot; = &quot;bikeshop.id&quot;))
glimpse(bike_orderlines_joined_tbl)</code></pre>
<pre><code>## Rows: 15,644
## Columns: 19
## $ ...1           &lt;chr&gt; &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;11…
## $ order.id       &lt;dbl&gt; 1, 1, 2, 2, 3, 3, 3, 3, 3, 4, 5, 5, 5, 5, 6, 6, 6, 6, …
## $ order.line     &lt;dbl&gt; 1, 2, 1, 2, 1, 2, 3, 4, 5, 1, 1, 2, 3, 4, 1, 2, 3, 4, …
## $ order.date     &lt;dttm&gt; 2015-01-07, 2015-01-07, 2015-01-10, 2015-01-10, 2015-…
## $ customer.id    &lt;dbl&gt; 2, 2, 10, 10, 6, 6, 6, 6, 6, 22, 8, 8, 8, 8, 16, 16, 1…
## $ product.id     &lt;dbl&gt; 2681, 2411, 2629, 2137, 2367, 1973, 2422, 2655, 2247, …
## $ quantity       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, …
## $ model          &lt;chr&gt; &quot;Spectral CF 7 WMN&quot;, &quot;Ultimate CF SLX Disc 8.0 ETAP&quot;, …
## $ model.year     &lt;dbl&gt; 2021, 2020, 2021, 2019, 2020, 2020, 2020, 2021, 2020, …
## $ frame.material &lt;chr&gt; &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;aluminium&quot;, &quot;…
## $ weight         &lt;dbl&gt; 13.80, 7.44, 14.06, 8.80, 11.50, 8.80, 8.20, 8.85, 14.…
## $ price          &lt;dbl&gt; 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899, …
## $ category       &lt;chr&gt; &quot;Mountain - Trail - Spectral&quot;, &quot;Road - Race - Ultimate…
## $ gender         &lt;chr&gt; &quot;female&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;unisex&quot;, &quot;uni…
## $ url            &lt;chr&gt; &quot;https://www.canyon.com/en-de/mountain-bikes/trail-bik…
## $ name           &lt;chr&gt; &quot;AlexandeRad&quot;, &quot;AlexandeRad&quot;, &quot;WITT-RAD&quot;, &quot;WITT-RAD&quot;, …
## $ location       &lt;chr&gt; &quot;Hamburg, Hamburg&quot;, &quot;Hamburg, Hamburg&quot;, &quot;Bremen, Breme…
## $ lat            &lt;dbl&gt; 53.57532, 53.57532, 53.07379, 53.07379, 48.78234, 48.7…
## $ lng            &lt;dbl&gt; 10.015340, 10.015340, 8.826754, 8.826754, 9.180819, 9.…</code></pre>
<p>We now organize the data in the table to give us better insights</p>
<pre class="r"><code>bike_orderlines_wrangled_tbl &lt;- bike_orderlines_joined_tbl %&gt;%
  separate(col = category,
           into = c(&quot;category.1&quot;,&quot;category.2&quot;,&quot;category.3&quot;),
           sep = &quot; - &quot;) %&gt;%
  mutate(total.price = price*quantity) %&gt;%
  select(-...1, -gender) %&gt;%
  select(-ends_with(&quot;.id&quot;)) %&gt;%
  bind_cols(bike_orderlines_joined_tbl %&gt;% select(order.id)) %&gt;%
  
  select(order.id, contains(&quot;order&quot;), contains(&quot;model&quot;), contains(&quot;category&quot;), price, quantity, total.price, everything()) %&gt;%
  rename(bikeshop = name) %&gt;%
  set_names(names(.) %&gt;% str_replace_all(&quot;\\.&quot;,&quot;_&quot;))
glimpse(bike_orderlines_wrangled_tbl)</code></pre>
<pre><code>## Rows: 15,644
## Columns: 18
## $ order_id       &lt;dbl&gt; 1, 1, 2, 2, 3, 3, 3, 3, 3, 4, 5, 5, 5, 5, 6, 6, 6, 6, …
## $ order_line     &lt;dbl&gt; 1, 2, 1, 2, 1, 2, 3, 4, 5, 1, 1, 2, 3, 4, 1, 2, 3, 4, …
## $ order_date     &lt;dttm&gt; 2015-01-07, 2015-01-07, 2015-01-10, 2015-01-10, 2015-…
## $ model          &lt;chr&gt; &quot;Spectral CF 7 WMN&quot;, &quot;Ultimate CF SLX Disc 8.0 ETAP&quot;, …
## $ model_year     &lt;dbl&gt; 2021, 2020, 2021, 2019, 2020, 2020, 2020, 2021, 2020, …
## $ category_1     &lt;chr&gt; &quot;Mountain&quot;, &quot;Road&quot;, &quot;Mountain&quot;, &quot;Road&quot;, &quot;Mountain&quot;, &quot;H…
## $ category_2     &lt;chr&gt; &quot;Trail&quot;, &quot;Race&quot;, &quot;Trail&quot;, &quot;Triathlon Bike&quot;, &quot;Dirt Jump…
## $ category_3     &lt;chr&gt; &quot;Spectral&quot;, &quot;Ultimate&quot;, &quot;Neuron&quot;, &quot;Speedmax&quot;, &quot;Stitche…
## $ price          &lt;dbl&gt; 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899, …
## $ quantity       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, …
## $ total_price    &lt;dbl&gt; 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899, …
## $ frame_material &lt;chr&gt; &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;carbon&quot;, &quot;aluminium&quot;, &quot;…
## $ weight         &lt;dbl&gt; 13.80, 7.44, 14.06, 8.80, 11.50, 8.80, 8.20, 8.85, 14.…
## $ url            &lt;chr&gt; &quot;https://www.canyon.com/en-de/mountain-bikes/trail-bik…
## $ bikeshop       &lt;chr&gt; &quot;AlexandeRad&quot;, &quot;AlexandeRad&quot;, &quot;WITT-RAD&quot;, &quot;WITT-RAD&quot;, …
## $ location       &lt;chr&gt; &quot;Hamburg, Hamburg&quot;, &quot;Hamburg, Hamburg&quot;, &quot;Bremen, Breme…
## $ lat            &lt;dbl&gt; 53.57532, 53.57532, 53.07379, 53.07379, 48.78234, 48.7…
## $ lng            &lt;dbl&gt; 10.015340, 10.015340, 8.826754, 8.826754, 9.180819, 9.…</code></pre>
<p>Now we have to separate the location column into city and State</p>
<pre class="r"><code>bike_orderlines_wrangled_tbl &lt;- bike_orderlines_wrangled_tbl %&gt;% separate(col = location,
                                          into = c(&quot;City&quot;, &quot;State&quot;),
                                          sep = &quot;, &quot;)</code></pre>
<p>Now we analyze the above table based on sales per State</p>
<pre class="r"><code>sales_by_state_tbl &lt;- bike_orderlines_wrangled_tbl %&gt;%
  select(State, total_price) %&gt;%
  group_by(State) %&gt;%
  summarise(sales = sum(total_price)) %&gt;%
  mutate(sales_text = scales::dollar(sales, big.mark = &quot;.&quot;,
                                     decimal.mark = &quot;,&quot;,
                                     prefix = &quot;&quot;,
                                     suffix = &quot; €&quot;))
sales_by_state_tbl</code></pre>
<pre><code>## # A tibble: 12 x 3
##    State                            sales sales_text  
##    &lt;chr&gt;                            &lt;dbl&gt; &lt;chr&gt;       
##  1 Baden-Württemberg              6521090 6.521.090 € 
##  2 Bavaria                        6742819 6.742.819 € 
##  3 Berlin                         1128433 1.128.433 € 
##  4 Bremen                        10653499 10.653.499 €
##  5 Hamburg                        3874756 3.874.756 € 
##  6 Hesse                          1558901 1.558.901 € 
##  7 Lower Saxony                   4107115 4.107.115 € 
##  8 Mecklenburg-Western Pomerania   618974 618.974 €   
##  9 North Rhine-Westphalia        21200613 21.200.613 €
## 10 Saxony                         2230245 2.230.245 € 
## 11 Saxony-Anhalt                   569614 569.614 €   
## 12 Schleswig-Holstein             3224749 3.224.749 €</code></pre>
</div>
<div id="data-visualization" class="section level2">
<h2><span class="header-section-number">4.4</span> Data Visualization</h2>
<p>We now plot the data from the table to better visualize it</p>
<pre class="r"><code>sales_by_state_tbl %&gt;%
  ggplot(aes(x = State, y = sales)) + 
  geom_col(fill = &quot;#2DC6D6&quot;)  +
  geom_smooth(method = &quot;lm&quot;, se = FALSE) + 
  scale_y_continuous(labels = scales::dollar_format(big.mark = &quot;.&quot;, 
                                                    decimal.mark = &quot;,&quot;, 
                                                    prefix = &quot;&quot;, 
                                                    suffix = &quot; €&quot;)) + 
  labs(title = &quot;Revenue per State&quot;,
       subtitle = &quot;Upward Trend&quot;,
       x = &quot;&quot;,
       y = &quot;Revenue&quot;) +
  theme(axis.text.x = element_text(angle=45, hjust = 1))</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>From the plot above, it is clear that the State where the revenue was bigger is North Rhine-Westphalia.</p>
<p>We now move on to analyze the sales by location and year. We first create a new table containing only the important information. This new table should contain the year, revenue, and location.</p>
<pre class="r"><code>sales_by_location_year_tbl &lt;- bike_orderlines_wrangled_tbl %&gt;%
  select(order_date, State, total_price) %&gt;%
  mutate(Year = year(order_date)) %&gt;%
  group_by(State, Year) %&gt;%
  summarise(sales = sum(total_price)) %&gt;%
  ungroup() %&gt;%
  mutate(sales_text = scales::dollar(sales, big.mark = &quot;.&quot;,
                                     decimal.mark = &quot;,&quot;,
                                     prefix = &quot;&quot;,
                                     suffix = &quot; €&quot;))
glimpse(sales_by_location_year_tbl)</code></pre>
<pre><code>## Rows: 60
## Columns: 4
## $ State      &lt;chr&gt; &quot;Baden-Württemberg&quot;, &quot;Baden-Württemberg&quot;, &quot;Baden-Württembe…
## $ Year       &lt;dbl&gt; 2015, 2016, 2017, 2018, 2019, 2015, 2016, 2017, 2018, 2019…
## $ sales      &lt;dbl&gt; 1031924, 1561658, 1224152, 1114327, 1589029, 1301461, 1129…
## $ sales_text &lt;chr&gt; &quot;1.031.924 €&quot;, &quot;1.561.658 €&quot;, &quot;1.224.152 €&quot;, &quot;1.114.327 €&quot;…</code></pre>
<p>We finally analyze the data with the help of column plots. There are 12 states with bike stores, meaning 12 plots.</p>
<pre class="r"><code>sales_by_location_year_tbl %&gt;%
  ggplot(aes(x = Year, y = sales, fill = State)) +
  geom_col() + 
  facet_wrap(~ State) + 
  scale_y_continuous(labels = scales::dollar_format(big.mark = &quot;.&quot;, 
                                                    decimal.mark = &quot;,&quot;, 
                                                    prefix = &quot;&quot;, 
                                                    suffix = &quot; €&quot;)) +
  labs(title = &quot;Revenue by year and main State&quot;,
       fill = &quot;Main category&quot;) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1))</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
</div>
<div id="challenge-3-data-acquisition" class="section level1">
<h1><span class="header-section-number">5</span> Challenge 3 Data Acquisition</h1>
<div id="getting-data-from-an-arbitrary-api" class="section level2">
<h2><span class="header-section-number">5.1</span> Getting Data from an Arbitrary API</h2>
<p>We need to get data via an API. For this example, I will be fetching data from a Brazilian API that provides information about car prices sold in Brazil</p>
<pre class="r"><code># import the httr library
library(httr)

# request access the the Brazilian car API
response &lt;- GET(&quot;https://parallelum.com.br/fipe/api/v1/carros/marcas/39/modelos&quot;) %&gt;%
  # Go the the folder containing the Mercedes-Benz models
  content(as = &quot;text&quot;) %&gt;% fromJSON() %&gt;% .$modelos %&gt;% as.tibble() %&gt;% select(nome) %&gt;%     rename(&quot;Mercedes Model&quot; = nome)

print(response, n = 10)</code></pre>
<pre><code>## # A tibble: 445 x 1
##    `Mercedes Model`               
##    &lt;chr&gt;                          
##  1 180-D Pick-Up/Furgão 2.4 Diesel
##  2 180-D Van 2.4 Diesel           
##  3 190-E 2.3                      
##  4 230-E 2.3                      
##  5 260-E 2.6                      
##  6 300-D 3.0 Diesel               
##  7 300-E 3.0                      
##  8 300-SE 3.0/3.2                 
##  9 300-SL 3.0                     
## 10 300-TE Wagon 3.0               
## # … with 435 more rows</code></pre>
</div>
<div id="creating-a-database-from-canyons-competitor" class="section level2">
<h2><span class="header-section-number">5.2</span> Creating a Database from Canyon’s Competitor</h2>
<p>We now scrape the website of one of the competitors of Canyon Rose Bikes. We create a small database that contains the model names, and the prices for at least one category.</p>
<p>Let’s first import all of the necessary libraries</p>
<pre class="r"><code>library(tidyverse) # Main Package - Loads dplyr, purrr, etc.
library(rvest)     # HTML Hacking &amp; Web Scraping
library(xopen)     # Quickly opening URLs
library(jsonlite)  # converts JSON files to R objects
library(glue)      # concatenate strings
library(stringi)   # character string/text processing</code></pre>
<p>Now we read the html code from the website</p>
<pre class="r"><code># provide the home URL and read it
url_home          &lt;- &quot;https://www.rosebikes.de/&quot;
html_home &lt;- read_html(url_home)</code></pre>
<p>we then scrape the models of the bikes</p>
<pre class="r"><code># Create a new table with the categories
rose_bike_category &lt;- html_home %&gt;% 
  # Go to the node where the category names are located
  html_nodes(css = &quot;.header-mobile-menu-item__title&quot;) %&gt;% html_text() %&gt;%
  # Extract the unecessary symbols
  str_extract(pattern = &quot;(?&lt;=\\n).*(?=\\n)&quot;) %&gt;%
  # slice the rows that don&#39;t have a category
  as.tibble() %&gt;% slice(3:11) %&gt;%
  # Create a new column for the specific category URLs
  mutate(model_url = str_glue(&quot;{url_home}fahrräder/{value}&quot;))

rose_bike_category</code></pre>
<pre><code>## # A tibble: 9 x 2
##   value      model_url                                    
##   &lt;chr&gt;      &lt;glue&gt;                                       
## 1 MTB        https://www.rosebikes.de/fahrräder/MTB       
## 2 Rennrad    https://www.rosebikes.de/fahrräder/Rennrad   
## 3 Gravel     https://www.rosebikes.de/fahrräder/Gravel    
## 4 Cyclocross https://www.rosebikes.de/fahrräder/Cyclocross
## 5 Fitness    https://www.rosebikes.de/fahrräder/Fitness   
## 6 E-Bike     https://www.rosebikes.de/fahrräder/E-Bike    
## 7 Trekking   https://www.rosebikes.de/fahrräder/Trekking  
## 8 Reise      https://www.rosebikes.de/fahrräder/Reise     
## 9 Urban      https://www.rosebikes.de/fahrräder/Urban</code></pre>
<p>The next step is to scrape the models of the first category “MTB”</p>
<pre class="r"><code># Create a new table with the products of the MTB category
# We use the URL from the first row of the previous table
rose_bike_models &lt;- rose_bike_category$model_url[1]  %&gt;% 
  read_html() %&gt;%
  # Go to the node that contains the product name
  html_nodes(css = &quot;.catalog-category-bikes__title-text&quot;) %&gt;% html_text() %&gt;%
  # Extract the unecessary characters
  str_extract(pattern = &quot;(?&lt;=\\n).*(?=\\n)&quot;) %&gt;%
  as.tibble() %&gt;%
  rename(&quot;MTB Models&quot; = value) 

# Create a new column with an ID for future merging
rose_bike_models$ID &lt;- seq.int(nrow(rose_bike_models))
rose_bike_models &lt;- select(rose_bike_models, ID, &quot;MTB Models&quot;)

rose_bike_models</code></pre>
<pre><code>## # A tibble: 9 x 2
##      ID `MTB Models`     
##   &lt;int&gt; &lt;chr&gt;            
## 1     1 GROUND CONTROL   
## 2     2 ROOT MILLER      
## 3     3 PIKES PEAK       
## 4     4 THE BRUCE        
## 5     5 COUNT SOLO       
## 6     6 PSYCHO PATH      
## 7     7 THRILL HILL      
## 8     8 THRILL HILL TRAIL
## 9     9 SOUL FIRE</code></pre>
<p>We now get a table with the prices of each MTB model</p>
<pre class="r"><code># We create a new table with the prices of the individual MTB bikes
rose_bike_MTB_price &lt;- rose_bike_category$model_url[1]  %&gt;% 
  read_html() %&gt;%
  # We go to the node containing the prices
  html_nodes(css = &quot;.catalog-category-bikes__price-title&quot;) %&gt;% html_text() %&gt;%
  # We get rid of unecessary characters
  stringr::str_extract(pattern = &quot;(?&lt;=ab ).*?(?=\\n)&quot;) %&gt;%
  as.tibble() %&gt;%
  rename(&quot;MTB Models Price&quot; = value) 
 
# We create a new column with bike IDs for future merging
rose_bike_MTB_price$ID &lt;- seq.int(nrow(rose_bike_models))
rose_bike_MTB_price &lt;- select(rose_bike_MTB_price, ID, &quot;MTB Models Price&quot;)

rose_bike_MTB_price</code></pre>
<pre><code>## # A tibble: 9 x 2
##      ID `MTB Models Price`
##   &lt;int&gt; &lt;chr&gt;             
## 1     1 1.699,00 €        
## 2     2 1.999,00 €        
## 3     3 3.099,00 €        
## 4     4 &lt;NA&gt;              
## 5     5 &lt;NA&gt;              
## 6     6 1.849,00 €        
## 7     7 2.599,00 €        
## 8     8 2.899,00 €        
## 9     9 2.149,00 €</code></pre>
<p>We finally join the two tables in one database</p>
<pre class="r"><code># We merge the two tables based on the ID
rose_bike &lt;- rose_bike_models %&gt;% left_join(rose_bike_MTB_price)

rose_bike</code></pre>
<pre><code>## # A tibble: 9 x 3
##      ID `MTB Models`      `MTB Models Price`
##   &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;             
## 1     1 GROUND CONTROL    1.699,00 €        
## 2     2 ROOT MILLER       1.999,00 €        
## 3     3 PIKES PEAK        3.099,00 €        
## 4     4 THE BRUCE         &lt;NA&gt;              
## 5     5 COUNT SOLO        &lt;NA&gt;              
## 6     6 PSYCHO PATH       1.849,00 €        
## 7     7 THRILL HILL       2.599,00 €        
## 8     8 THRILL HILL TRAIL 2.899,00 €        
## 9     9 SOUL FIRE         2.149,00 €</code></pre>
</div>
</div>
<div id="challenge-4---data-wrangling" class="section level1">
<h1><span class="header-section-number">6</span> Challenge 4 - Data Wrangling</h1>
<div id="part-1---patent-dominance" class="section level2">
<h2><span class="header-section-number">6.1</span> Part 1 - Patent Dominance</h2>
<p>What US company / corporation has the most patents? List the 10 US companies with the most assigned/granted patents.</p>
<p>We obtain data from the United States Patent and Trademark Office. The first data set to get is the one containing the assignees.</p>
<pre class="r"><code># import the vroom library
library(vroom)
library(data.table)
library(dplyr)
# Get the assignee dataset
# define the column names and types based on the Excel spreadsheet
col_types &lt;- list(
  id = col_character(),
  type = col_double(),
  name_first = col_character(),
  name_last = col_character(),
  organization = col_character()

)

# import file patent.tsv
assignee_tbl &lt;- vroom(
            file       = &quot;assignee.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )</code></pre>
<p>For this project, we also need the name of the companies that issued the patent. These are not included in the first table. We must therefore download and import the table “patent_assignee.tsv” that contains the organization name. We will later link it to the “assignee.tsv” table by using the patent id.</p>
<pre class="r"><code># Get the &quot;patent_assignee&quot; data set
# define the column names and types based on the Excel spreadsheet
col_types &lt;- list(
  patent_id = col_character(),
  assignee_id = col_character(),
  location_id = col_character()

)

# import file patent.tsv
patent_assignee_tbl &lt;- vroom(
            file       = &quot;patent_assignee.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )</code></pre>
<p>We now convert both tables to a data.table format and merge them based on the assignee Id.</p>
<pre class="r"><code># convert the data frame format to the data.table format
setDT(assignee_tbl)
setDT(patent_assignee_tbl)

# We rename the id column of the assignee_tbl, so that it has the same name as the assignee_id column in the patent_assignee_tbl. We also select only the important columns

 assignee_tbl &lt;- assignee_tbl[, .(assignee_id = id, type, organization)]</code></pre>
<p>We now merge the two tables based on the same variable “assignee_id”</p>
<pre class="r"><code># Create a new table by merging the existing tables through the commnon column &quot;assignee_id&quot;
combined_patent_tbl &lt;- assignee_tbl %&gt;%
  left_join(patent_assignee_tbl, by = &quot;assignee_id&quot;)

# We can extract only the two important columns of this table for this first analysis, namely the organization name and the patent ID columns
org_pat_tbl_copy &lt;- combined_patent_tbl
org_pat_tbl &lt;- combined_patent_tbl[, .(patent_id), by = organization]


rm(assignee_tbl)
rm(patent_assignee_tbl)</code></pre>
<p>Now we can simply count the number of occurrencies of each organization name. This will give the number of patents issued by such organization.</p>
<pre class="r"><code>org_pat_tbl &lt;- org_pat_tbl[!is.na(organization), .(number_of_patents = .N), by = organization]

# we then arrange in decreasing format and select the top 10 companies with the most patents.
top_10_pat_org &lt;- org_pat_tbl %&gt;% ungroup() %&gt;% arrange(desc(number_of_patents)) %&gt;% slice(1:10)

write_rds(top_10_pat_org, &quot;top_10_pat_org.rds&quot;)

rm(org_pat_tbl)</code></pre>
<p>we now display the results of the top 10 companies in terms of number of patents</p>
<pre class="r"><code>read_rds(&quot;top_10_pat_org.rds&quot;)</code></pre>
<pre><code>##                                    organization number_of_patents
##  1: International Business Machines Corporation            139092
##  2:               Samsung Electronics Co., Ltd.             93562
##  3:                      Canon Kabushiki Kaisha             75910
##  4:                            Sony Corporation             54343
##  5:                    Kabushiki Kaisha Toshiba             49443
##  6:                    General Electric Company             47122
##  7:                               Hitachi, Ltd.             45375
##  8:                           Intel Corporation             42157
##  9:                             Fujitsu Limited             37197
## 10:   Hewlett-Packard Development Company, L.P.             35573</code></pre>
</div>
<div id="part-2---recent-patent-acitivity" class="section level2">
<h2><span class="header-section-number">6.2</span> Part 2 - Recent patent acitivity</h2>
<p>What US company had the most patents granted in 2019? List the top 10 companies with the most new granted patents for 2019.</p>
<p>For this part of the challenge, we also need to load the data set “patent.tsv”</p>
<pre class="r"><code># prepare column names and type
col_types &lt;- list(
  id = col_character(),
  type = col_character(),
  number = col_character(),
  country = col_character(),
  date = col_date(&quot;%Y-%m-%d&quot;),
  abstract = col_character(),
  title = col_character(),
  kind = col_character(),
  num_claims = col_double(),
  filename = col_character(),
  withdrawn = col_double()
)

# import dataset
patent_tbl &lt;- vroom(
            file       = &quot;patent.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )</code></pre>
<p>We can extract only the two most important columns for this part of the challenge: the “patent id” and the “date”</p>
<pre class="r"><code># set table as data.table type
patent_short_table &lt;- patent_tbl %&gt;% select(id,date)
setDT(patent_short_table)
rm(patent_tbl)
# we rename the id column to use it as a key with the previous table

patent_short_table &lt;- patent_short_table[, .(patent_id = id, date)]

# now we merge it with the previous combined table

combined_patent_date_tbl &lt;- combined_patent_tbl %&gt;%
  left_join(patent_short_table, by = &quot;patent_id&quot;)

# Now we select the rows that are valid and that were issued in the year 2019. We count the number of occurrences for these patents in 2019 for each organization. We finally order them and select the top 10

combined_patent_date_tbl &lt;- combined_patent_date_tbl[!is.na(date), .(patent_year = lubridate::year(date)), by = organization][
  patent_year == 2019][!is.na(organization)
    , .(num_patents_2019 = .N), by = organization
  ][
    order(num_patents_2019, decreasing = TRUE)
  ][
    1:10
  ]

write_rds(combined_patent_date_tbl, &quot;num_patents_2019.rds&quot;)</code></pre>
<p>we now print the results of the Top 10 companies with most patents in 2019.</p>
<pre class="r"><code>read_rds(&quot;num_patents_2019.rds&quot;)</code></pre>
<pre><code>##                                    organization num_patents_2019
##  1: International Business Machines Corporation             9265
##  2:               Samsung Electronics Co., Ltd.             7205
##  3:                      Canon Kabushiki Kaisha             3595
##  4:                           Intel Corporation             3526
##  5:                         LG Electronics Inc.             3314
##  6:         Microsoft Technology Licensing, LLC             3106
##  7:                                  Apple Inc.             2817
##  8:               Ford Global Technologies, LLC             2624
##  9:                   Amazon Technologies, Inc.             2533
## 10:               Huawei Technologies Co., Ltd.             2454</code></pre>
</div>
<div id="part-3---innovation-in-tech" class="section level2">
<h2><span class="header-section-number">6.3</span> Part 3 - Innovation in Tech:</h2>
<p>What is the most innovative tech sector? For the top 10 companies (worldwide) with the most patents, what are the top 5 USPTO tech main classes?</p>
<pre class="r"><code># for this part of the challenge, we are going to need another data set &quot;uspc.tsv&quot;
# prepare column names and type
col_types &lt;- list(
  uuid = col_character(),
  patent_id = col_character(),
  mainclass_id = col_character(),
  subclass_id = col_character(),
  sequence = col_double()

)

# import data set
uspc_tbl &lt;- vroom(
            file       = &quot;uspc.tsv&quot;, 
            delim      = &quot;\t&quot;, 
            col_types  = col_types,
            na         = c(&quot;&quot;, &quot;NA&quot;, &quot;NULL&quot;)
        )</code></pre>
<p>We now reference a copy of the merged table, done for the first step of this challenge. We build a table that contains the organization name, the patent_id and the mainclass_id.</p>
<pre class="r"><code># set them as data.table
setDT(uspc_tbl)
setDT(org_pat_tbl_copy)

# we first collect only the important part of the org_pat_tbl_copy table, namely the organization name and the patent_id.
org_pat_tbl_copy &lt;- org_pat_tbl_copy[!is.na(location_id), .(patent_id, organization)]

# we now filter the uspc table to get just the patent_id and the mainclass_id

uspc_pat_main_id_tbl &lt;- uspc_tbl[, .(patent_id, mainclass_id)]</code></pre>
<p>We now merge the two tables based on the patent_id</p>
<pre class="r"><code># Create a new table by merging the existing tables through the commnon column &quot;patent_id&quot;
comb_patent_mainclass_tbl &lt;- org_pat_tbl_copy %&gt;%
  left_join(uspc_pat_main_id_tbl, by = &quot;patent_id&quot;)

# filter out those companies that do not have a mainclass_id assigned
comb_patent_mainclass_tbl &lt;- comb_patent_mainclass_tbl[!is.na(mainclass_id), 
                                                       .(mainclass_id), by = organization]</code></pre>
<p>We can refer to the first part of the challenge and only select the companies among the top 10 companies in total number of patents.</p>
<pre class="r"><code>library(tidyr)
# We gather the top 10 companies in total number of patents from part one of the challenge
top_10_pat_org_copy &lt;- top_10_pat_org[,.(organization)]

# we now merge this table above with the mainclass table and filter out the na values. This is done by using the key method. We then count the number of times a given patent mainclass_id appeared in these top 10 companies.

setkey(comb_patent_mainclass_tbl, organization)
setkey(top_10_pat_org_copy, organization)

top_10_main_id &lt;- comb_patent_mainclass_tbl[top_10_pat_org_copy, on = &quot;organization&quot;][ , .N, by = mainclass_id
][
  order(N, decreasing = TRUE)
][
  1:5, .(`Top 5 Classes` = mainclass_id, `Number of Patents` = N)
]

write_rds(top_10_main_id, &quot;top_10_mainclass.rds&quot;)</code></pre>
<p>We print the results showing the top 5 main classes Ids from the top 10 companies in the world based on number of patents issued.</p>
<pre class="r"><code>print(read_rds(&quot;top_10_mainclass.rds&quot;))</code></pre>
<pre><code>##    Top 5 Classes Number of Patents
## 1:           257             90966
## 2:           438             52058
## 3:           365             40276
## 4:           370             36361
## 5:           358             36226</code></pre>
</div>
</div>
<div id="challenge-5---data-visualization" class="section level1">
<h1><span class="header-section-number">7</span> Challenge 5 - Data Visualization</h1>
<p>We will deal with the Covid data and use tidyverse to wrangle the data.</p>
<pre class="r"><code># Let&#39;s first load the libraries and the dataset
library(tidyverse)
covid_data_tbl &lt;- read_csv(&quot;https://opendata.ecdc.europa.eu/covid19/casedistribution/csv&quot;)</code></pre>
</div>
<div id="part-1" class="section level1">
<h1><span class="header-section-number">8</span> Part 1</h1>
<p>The goal is to map the time course of the cumulative Covid-19 cases.</p>
<pre class="r"><code># Let&#39;s first filter out the countries that are relevant for this analysis

covid_analysis &lt;- covid_data_tbl %&gt;% 
  
  select(dateRep, cases, countriesAndTerritories) %&gt;%
  filter(countriesAndTerritories %in% c(&quot;Germany&quot;, &quot;United_Kingdom&quot;, &quot;France&quot;, &quot;Spain&quot;, &quot;United_States_of_America&quot;)) %&gt;%

# We now order the rows based on country and date, and create a new column containing the cumulative sum of the cases for each country
  
  group_by(countriesAndTerritories) %&gt;%
  mutate(date = dmy(dateRep)) %&gt;%
  arrange(countriesAndTerritories, date) %&gt;%

  mutate(Cumulative_Sum = cumsum(cases)) %&gt;%
  filter(year(date) == 2020) %&gt;%
  mutate(month = month(date, label = TRUE)) %&gt;% 
  mutate(sum_format = scales::dollar(Cumulative_Sum, big.mark = &quot;.&quot;,
                                     decimal.mark    = &quot;,&quot;,
                                     prefix          = &quot;&quot;))

 View(covid_analysis)

# The Next Step is to begin visualizing the date

covid_analysis %&gt;%
  
  # We determine the X and Y axis, as well as differentiatte the different curves by country
  
  ggplot(aes(date, Cumulative_Sum, color = countriesAndTerritories)) +
  
  geom_line(aes(color = countriesAndTerritories), size = 1) +
  
  # We adjust the X axis to show only the months in 2020. We also make the notation in the Y axis easier to read.

  scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b&quot;) +


  scale_y_continuous(labels = scales::dollar_format(scale = 1e-6,
                                                      prefix = &quot;&quot;,
                                                      suffix = &quot; M&quot;), breaks = seq(0,15e6, by = 2.5e6)) +


  # We create a label on the last data point for the United States Curve, as shown in the challenge objective
  
geom_label(data = filter(covid_analysis, Cumulative_Sum ==last(Cumulative_Sum), countriesAndTerritories %in% &quot;United_States_of_America&quot;), aes(label = sum_format, fill = countriesAndTerritories), hjust = &quot;inward&quot;,
               size  = 3,
               color = RColorBrewer::brewer.pal(n = 11, name = &quot;RdBu&quot;)[11], show.legend = FALSE) +

  # We write all of the titles of the axis
labs(
      title = &quot;COVID-19 Confirmed Cases Worldwide&quot;,
      x = &quot;Year 2020&quot;,
      y = &quot;Cumulative Cases&quot;

    ) +

  # We change the default coloring and position of the legend
theme_economist() +

theme(
      axis.text.x = element_text(angle = 45, hjust = -1),
      plot.title = element_text(face = &quot;bold&quot;),
      plot.caption = element_text(face = &quot;bold.italic&quot;),
      legend.position = &quot;bottom&quot;,
      legend.direction = &quot;vertical&quot;) +

scale_color_viridis_d(option = &quot;D&quot;)</code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
</div>
<div id="part-2" class="section level1">
<h1><span class="header-section-number">9</span> Part 2</h1>
<p>We want now to visualize the mortality rate (deaths / population).</p>
<pre class="r"><code># We access the longitudinal and lateral data

world &lt;- map_data(&quot;world&quot;)

# We now adjust the current table so that the countries all have the same name

covid_map &lt;- covid_data_tbl%&gt;%
   mutate(across(countriesAndTerritories, str_replace_all, &quot;_&quot;, &quot; &quot;)) %&gt;%
   mutate(countriesAndTerritories = case_when(

    countriesAndTerritories == &quot;United Kingdom&quot; ~ &quot;UK&quot;,
    countriesAndTerritories == &quot;United States of America&quot; ~ &quot;USA&quot;,
    countriesAndTerritories == &quot;Czechia&quot; ~ &quot;Czech Republic&quot;,
    TRUE ~ countriesAndTerritories

  )) %&gt;%
  
  # We select the important columns, and create a new column containing the death rate per population
  mutate(region = countriesAndTerritories) %&gt;%
  select(region, deaths, popData2019) %&gt;%
  group_by(region) %&gt;%
  summarise(deathRate = sum(deaths)/popData2019) %&gt;%
  distinct(region, .keep_all = TRUE) %&gt;%
  mutate(death_rate_formatted = scales::percent(deathRate, accuracy = 0.001 ))

# Now we can join the two table

covid_map &lt;- covid_map %&gt;%
  left_join(world, by = &quot;region&quot;) %&gt;%
  distinct(region, .keep_all = TRUE) %&gt;%
  mutate(`Mortality Rate` = deathRate)

# We now put the this data into the map argument of geom_map()

covid_map %&gt;% ggplot() + 
  geom_map(aes(x = long, y = lat, map_id = region, fill = `Mortality Rate`, label = death_rate_formatted), map = world) +
  
  # We now do the formatting so that it looks nice

  theme_minimal() + 
  
  # Writing the labels
  labs(
    
    title = &quot;Confirmed COVID-19 deaths relative to the size of the population&quot;,
    subtitle = &quot;More than 1.2 Million confirmed Covid-19 deaths worldwide&quot;,
    x = &quot;&quot;,
    y = &quot;&quot;,
    caption = &quot;Date: 05/12/2020&quot;
  ) + 
  
  # changing the legend colors, and format to percentage style
  scale_fill_continuous(labels = scales::percent_format(accuracy = 0.001), low = &quot;#a52a2a&quot;, high = &quot;black&quot;) </code></pre>
<p><img src="journal_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
